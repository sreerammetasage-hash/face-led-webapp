<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Object ‚Üí Arduino (class1 / class2) ‚Äî Colorful UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent1:#ff6b6b;
      --accent2:#6be0ff;
      --accent3:#8dff7a;
      --muted:#9aa7b2;
      --glass: rgba(255,255,255,0.04);
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:
      linear-gradient(180deg,#071023 0%,#081427 60%);color:#e6f0f6}
    .container{max-width:1100px;margin:20px auto;padding:20px;display:grid;grid-template-columns: 720px 1fr;gap:20px;}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow: 0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:10px;align-items:center}
    button{background:linear-gradient(90deg,#132b45,#0b2540);border:0;color:#e6f0f6;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:0 4px 14px rgba(2,6,23,0.6)}
    button.small{padding:8px 10px;font-size:14px}
    #webcam{width:100%;background:#000;border-radius:10px}
    .left {display:flex;flex-direction:column;gap:12px}
    .status-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .big-label{font-size:28px;font-weight:700;color:var(--accent2);display:flex;align-items:center;gap:12px}
    .confidence-bar{height:14px;background:linear-gradient(90deg,#102035,#0b1622);border-radius:8px;overflow:hidden;margin-top:8px}
    .confidence-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent3),var(--accent2));transition:width 160ms ease}
    .leds {display:flex;gap:12px;align-items:center;margin-top:8px}
    .led {width:28px;height:28px;border-radius:50%;background:#223239;box-shadow: inset 0 -6px 10px rgba(0,0,0,0.35);display:inline-block}
    .led.on.brush{background:linear-gradient(180deg,var(--accent1),#ff3b3b);box-shadow:0 0 18px rgba(255,107,107,0.6)}
    .led.on.batt{background:linear-gradient(180deg,var(--accent2),#2ccfff);box-shadow:0 0 18px rgba(107,224,255,0.45)}
    .controls-panel{display:flex;flex-direction:column;gap:12px;padding:8px}
    label{color:var(--muted);font-size:13px}
    .row{display:flex;align-items:center;gap:10px}
    .panel{display:flex;flex-direction:column;gap:8px}
    .option{display:flex;align-items:center;gap:10px}
    input[type=range]{width:100%}
    .right {display:flex;flex-direction:column;gap:12px}
    .card.small{padding:12px}
    .feature{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))}
    .log-box{height:220px;overflow:auto;background:var(--glass);padding:10px;border-radius:8px;color:var(--muted);font-size:13px}
    .footer {grid-column:1/-1;text-align:center;color:var(--muted);font-size:13px;margin-top:8px}
    .big-status{padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));font-weight:600}
    .snap {background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Object ‚Üí Arduino (class1 / class2)</h1>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Threshold & debounce controls ‚Ä¢ Sends 1 / 2 / 0 to Arduino</div>
      </div>
      <div class="controls">
        <button id="btnStart">Start Camera & Model</button>
        <button id="btnConnect">Connect Arduino</button>
        <button id="btnSnapshot" class="small">üì∏ Snapshot</button>
        <button id="btnDownload" class="small">‚¨áÔ∏è Download Log</button>
        <div style="width:8px"></div>
        <div id="status" class="big-status">Idle</div>
      </div>
    </header>

    <!-- LEFT: video and live info -->
    <div class="card left">
      <video id="webcam" autoplay playsinline muted></video>
      <div class="status-row">
        <div>
          <div class="big-label" id="detectedLabel">‚Äî</div>
          <div class="confidence-bar" aria-hidden="true">
            <div id="confidenceFill" class="confidence-fill"></div>
          </div>
          <div style="color:var(--muted);font-size:13px;margin-top:6px" id="confText">Confidence: 0%</div>
        </div>

        <div style="min-width:160px">
          <div style="font-size:13px;color:var(--muted)">LED Indicators</div>
          <div class="leds" style="margin-top:8px">
            <div style="text-align:center">
              <div id="ledBrush" class="led"></div>
              <div style="font-size:12px;color:var(--muted);margin-top:6px">class1</div>
            </div>
            <div style="text-align:center">
              <div id="ledBatt" class="led"></div>
              <div style="font-size:12px;color:var(--muted);margin-top:6px">class2</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: controls & features -->
    <div class="card right">
      <div class="card small controls-panel">
        <div class="panel">
          <label>Confidence Threshold: <strong id="thresholdVal">80%</strong></label>
          <input id="threshold" type="range" min="50" max="95" value="80" step="1">
        </div>

        <div class="panel">
          <label>Debounce (reduce flicker)</label>
          <div class="row">
            <label class="option"><input id="debounceToggle" type="checkbox"> Enable debounce</label>
            <div style="flex:1"></div>
            <label style="color:var(--muted)">Frames:</label>
            <select id="debounceFrames">
              <option>2</option><option selected>3</option><option>4</option><option>5</option>
            </select>
          </div>
        </div>

        <div class="panel">
          <label>Sound feedback</label>
          <div class="row">
            <label class="option"><input id="soundToggle" type="checkbox" checked> Play sound on change</label>
            <div style="flex:1"></div>
            <button id="themeBtn" class="small">Toggle Theme</button>
          </div>
        </div>

        <div class="panel">
          <label>Live log</label>
          <div class="log-box" id="logBox">No detections yet.</div>
        </div>

        <div class="panel" style="display:flex;gap:8px;align-items:center">
          <button id="clearLog" class="small">Clear Log</button>
          <div style="flex:1"></div>
          <div style="color:var(--muted);font-size:12px">Model: <span id="modelInfo">loading‚Ä¶</span></div>
        </div>
      </div>

      <div class="card small">
        <div style="font-weight:700">Quick tips</div>
        <ul style="color:var(--muted);margin-top:8px">
          <li>Use Chrome/Edge. Allow camera & USB permission when asked.</li>
          <li>Set Threshold to 80% to reduce false positives.</li>
          <li>Enable Debounce (3 frames) if detection flickers.</li>
        </ul>
      </div>
    </div>

    <div class="footer">Teacher: share this URL with students (Chrome). Arduino must be uploaded with UNO sketch (expects '1','2','0').</div>
  </div>

<script>
/* CONFIG - do not change if you're not comfortable editing code */
const MODEL_PATH = 'model/model.json';   // model folder at site root
let TOP_CONFIDENCE = 0.80;              // default 0.80 (80%)
const FRAME_INTERVAL_MS = 140;          // how often to predict (ms)
const SEND_CHARS = {cls1:'1', cls2:'2', none:'0'}; // chars sent to UNO

/* UI elements */
const video = document.getElementById('webcam');
const btnStart = document.getElementById('btnStart');
const btnConnect = document.getElementById('btnConnect');
const btnSnapshot = document.getElementById('btnSnapshot');
const btnDownload = document.getElementById('btnDownload');
const statusEl = document.getElementById('status');
const detectedLabel = document.getElementById('detectedLabel');
const confidenceFill = document.getElementById('confidenceFill');
const confText = document.getElementById('confText');
const ledBrush = document.getElementById('ledBrush');
const ledBatt = document.getElementById('ledBatt');
const thresholdSlider = document.getElementById('threshold');
const thresholdVal = document.getElementById('thresholdVal');
const debounceToggle = document.getElementById('debounceToggle');
const debounceFramesSelect = document.getElementById('debounceFrames');
const soundToggle = document.getElementById('soundToggle');
const logBox = document.getElementById('logBox');
const modelInfo = document.getElementById('modelInfo');
const clearLog = document.getElementById('clearLog');
const themeBtn = document.getElementById('themeBtn');

/* state */
let model = null;
let labels = null;
let port = null;
let writer = null;
let lastSent = null;
let log = [];
let debounceBuffer = [];
let consecutiveNeeded = 3;
let audioCtx = null;

/* helpers */
function setStatus(t){ statusEl.textContent = t; }
function appendLog(s){
  const ts = new Date().toLocaleTimeString();
  log.unshift(`${ts} ‚Äî ${s}`);
  logBox.innerText = log.slice(0,200).join('\n') || 'No detections yet.';
}
function playBeep(){
  if(!soundToggle.checked) return;
  try {
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.02;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  } catch(e){ /* ignore */ }
}
function updateLEDs(cmd){
  ledBrush.classList.toggle('on', cmd === '1');
  ledBatt.classList.toggle('on', cmd === '2');
}
async function safeSend(cmdChar){
  if(!writer) return;
  try {
    await writer.write(new TextEncoder().encode(cmdChar + '\n'));
  } catch(e){
    console.error('Write failed', e);
    setStatus('Serial write failed');
  }
}

/* UI events */
thresholdSlider.addEventListener('input', ()=>{
  thresholdVal.innerText = thresholdSlider.value + '%';
  TOP_CONFIDENCE = Number(thresholdSlider.value)/100;
});
thresholdSlider.value = 80;
thresholdVal.innerText = '80%';
debounceToggle.checked = false;
debounceFramesSelect.value = '3';

btnStart.onclick = async ()=>{
  setStatus('Starting camera...');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{width:640, height:480}, audio:false});
    video.srcObject = stream;
    await video.play();
  } catch(e){ alert('Camera error: ' + e.message); setStatus('Camera error'); return; }

  setStatus('Loading model...');
  try {
    model = await tf.loadLayersModel(MODEL_PATH);
    modelInfo.innerText = 'Loaded';
    // try metadata for labels
    try {
      const meta = await (await fetch('model/metadata.json')).json();
      labels = meta.labels || null;
    } catch(e){ labels = null; }
  } catch(e){ console.error(e); alert('Model load failed: ' + e.message); setStatus('Model load failed'); return; }
  setStatus('Model loaded');
  runLoop();
};

btnConnect.onclick = async ()=>{
  if(!('serial' in navigator)){ alert('Web Serial API not supported. Use Chrome/Edge.'); return; }
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    setStatus('Arduino connected');
    appendLog('Arduino connected');
  } catch(e){ console.error(e); alert('Serial connect failed: '+ e.message); setStatus('Serial failed'); }
};

btnSnapshot.onclick = ()=>{
  try {
    const c = document.createElement('canvas');
    c.width = video.videoWidth;
    c.height = video.videoHeight;
    const ctx = c.getContext('2d');
    ctx.drawImage(video,0,0,c.width,c.height);
    const url = c.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url; a.download = 'snapshot.png'; a.click();
  } catch(e){ alert('Snapshot failed'); }
};

btnDownload.onclick = ()=>{
  const blob = new Blob([log.join('\n')], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'detections.log'; a.click();
};

clearLog.addEventListener('click', ()=>{
  log = []; logBox.innerText = 'No detections yet.'; appendLog('Cleared log');
});

themeBtn.onclick = ()=>{
  document.body.style.background = (document.body.style.background ? '' : 'linear-gradient(180deg,#071023 0%,#081427 60%)');
  appendLog('Toggled theme');
};

/* main loop with optional debounce */
async function runLoop(){
  setStatus('Running');
  lastSent = null;
  debounceBuffer = [];
  while(model){
    try {
      const w = 224, h = 224;
      const off = document.createElement('canvas');
      off.width = w; off.height = h;
      const ctx = off.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const imgData = ctx.getImageData(0,0,w,h);
      let img = tf.browser.fromPixels(imgData).toFloat();
      let norm = img.div(127.5).sub(1.0);
      let bat = norm.expandDims(0);
      const preds = await model.predict(bat).data();
      const arr = Array.from(preds);
      const topIdx = arr.indexOf(Math.max(...arr));
      const topConf = arr[topIdx];
      const labelName = labels ? labels[topIdx] : ('class' + (topIdx+1));

      // Display
      detectedLabel.innerText = labelName.toUpperCase();
      const confPct = Math.round(topConf * 100);
      confText.innerText = `Confidence: ${confPct}%`;
      confidenceFill.style.width = Math.min(100, confPct) + '%';

      // decide candidate command
      let candidate = '0'; // none
      if (topConf >= TOP_CONFIDENCE) {
        if (topIdx === 0) candidate = SEND_CHARS.cls1; 
        else if (topIdx === 1) candidate = SEND_CHARS.cls2;
      } else candidate = '0';

      // debounce logic
      if (debounceToggle.checked) {
        const framesNeeded = Number(debounceFramesSelect.value || 3);
        debounceBuffer.push(candidate);
        if (debounceBuffer.length > framesNeeded) debounceBuffer.shift();
        const allSame = debounceBuffer.length >= framesNeeded && debounceBuffer.every(v => v === debounceBuffer[0]);
        if (allSame) {
          if (debounceBuffer[0] !== lastSent) {
            lastSent = debounceBuffer[0];
            await safeSend(lastSent);
            updateLEDs(lastSent);
            appendLog(`Sent ${lastSent} (${labelName} ${confPct}%)`);
            playBeep();
          }
        }
      } else {
        if (candidate !== lastSent) {
          lastSent = candidate;
          await safeSend(lastSent);
          updateLEDs(lastSent);
          appendLog(`Sent ${lastSent} (${labelName} ${confPct}%)`);
          playBeep();
        }
      }

      // tidy tensors
      bat.dispose(); img.dispose(); norm.dispose();

    } catch(e){
      console.error('Loop error', e);
      setStatus('Error in loop');
    }
    await new Promise(r => setTimeout(r, FRAME_INTERVAL_MS));
  }
}

/* close serial on page unload */
window.addEventListener('beforeunload', async () => {
  try { if(writer) await writer.close(); if(port) await port.close(); } catch(e){}
});
</script>
</body>
</html>
